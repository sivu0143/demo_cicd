$COMMAND = "cds"

Register-ArgumentCompleter -Native -CommandName $COMMAND -ScriptBlock {
    param($wordToComplete, $commandAst, $cursorPosition)

    $cmdSegments = $commandAst.CommandElements
    $idx = $cmdSegments.IndexOf(($cmdSegments | Where-Object { $_.Extent.Text -eq $wordToComplete }))
    if ($idx -gt 0) {
        $previousWord = $cmdSegments[$idx - 1].Extent.Text
    } else {
        $previousWord = $cmdSegments[$cmdSegments.Count - 1].Extent.Text
    }

    # double quoting needed to avoid word 'h' to be recognized as command shortcut 'help'
    $options = & $COMMAND completion --shell ps --prev "'$previousWord'" --curr "'$wordToComplete'" --line "'$commandAst'"
    foreach ($option in $options) {
        [System.Management.Automation.CompletionResult]::new($option, $option, 'ParameterValue', $option)
    }
}
