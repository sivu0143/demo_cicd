const cds = require('../../../cds'), { exists, fs, path } = cds.utils
const { readProject } = require('../../projectReader')
const { merge } = require('../../merge')

module.exports = class extends require('../../plugin') {

  static hasInProduction() {
    const startPage = path.join(cds.root, cds.env.folders.app, 'index.html')
    const packageJson = path.join(cds.root, 'package.json')
    return exists(startPage) && fs.readFileSync(startPage).includes('https://sapui5') ||
           exists(packageJson) && fs.readFileSync(packageJson).includes('"sapux":')
  }

  static help() {
    return 'SAP UI5 integration'
  }

  async run() {
    const project = readProject()
    await merge({ sapux: project.apps.map(({ app }) => project.appPath + app) }).into('package.json')
  }
}
