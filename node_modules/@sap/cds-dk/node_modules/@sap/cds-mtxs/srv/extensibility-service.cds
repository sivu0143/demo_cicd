using { cds.xt.Extensions } from '../db/extensions';
using from './jobs-service';

@protocol: 'rest'
@requires: ['cds.ExtensionDeveloper', 'internal-user']
service cds.xt.ExtensibilityService @(path:'/-/cds/extensibility', impl:'@sap/cds-mtxs/srv/extensibility-service.js') {

  type ActivationLevel : cds.xt.Extensions:activated;
  type CSN : String; // REVISIT: should reuse cds.xt.CSN
  type CSN_OR_CDL: String;
  type MESSAGE : {
    severity: String enum { error; warning; info };
    message: String;
  };
  type VALIDATION_RESULT : {
    errors: array of MESSAGE;
    messages: Array of MESSAGE;
  };

  type FILE {
    name: String;
    content: LargeString;
  }

  action set(
    extension  : array of CSN_OR_CDL,
    resources  : array of FILE,
    tag        : cds.xt.Extensions:tag, // optional
    activate   : ActivationLevel, // default #database
    tenant     : String // optional, for internal-user only
  );

  @cds.persistence.skip
  entity Extensions {
    key ID    : String;
    @open csn : array of CSN_OR_CDL;
    i18n      : array of FILE;
    csvs      : array of FILE; // not documented yet
    timestamp : Timestamp @cds.on.insert:$now @cds.on.update:$now;
    status : Integer enum {
      draft = 1;
      active = 2;
    }
  }

  action activate(ID: Extensions:ID, status: Extensions:status, @open options: {});

  action validate(ID: Extensions:ID ) returns VALIDATION_RESULT;

  action discard(ID: Extensions:ID);
}

/*
 * PRIVATE APIs!!!
 */
extend service cds.xt.ExtensibilityService with @private {

  type TAR : LargeBinary;

  @requires: ['cds.ExtensionDeveloper']
  @private action pull(tag: cds.xt.Extensions:tag) returns TAR;

  @requires: ['cds.ExtensionDeveloper']
  @private action push (
    extension : TAR,
    tag       : cds.xt.Extensions:tag,
    tenant    : String // optional, for internal-user only
  );

}

// Access to legacy content
extend service cds.xt.ExtensibilityService {

  @requires: ['cds.ExtensionDeveloper']
  @private action getMigratedProjects(
    tagRule: String,  // optional
    defaultTag: String, // optional
    tenant: String // optional
  ) returns LargeBinary;
}
